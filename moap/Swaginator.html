<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="pragma" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HUD Message — VH sizing</title>
<style>
  html,body{
    margin:0; padding:0; height:100%;
    background:#f7f4e9;             /* pale cream */
    color:#111;                      /* near-black text */
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
                 "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    overflow:hidden;                 /* only the message can scroll */
  }
  .wrap{width:100vw;height:100vh;}
  .card{width:100vw;height:100vh;display:grid;place-items:center;}
  .msg{
    box-sizing:border-box;
    max-width:100%; max-height:100%;
    padding: 1.2vmin;                         /* inner padding */
    padding-bottom: calc(1.2vmin + 6px);      /* descender cushion */
    font-size: 18vh;                          /* visible default if JS fails */
    line-height: 1.26;
    text-align: center;
    white-space: pre-wrap;                    /* keep \n newlines */
    word-break: break-word;
    overflow-wrap: anywhere;
    hyphens: auto;
    overflow: hidden;                         /* JS enables vertical scroll if needed */
    position:relative;
  }
  .msg.scrollable{
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:thin;
    scrollbar-color:#0e6b4f transparent;
  }
  .msg.scrollable::-webkit-scrollbar{ width:10px; }
  .msg.scrollable::-webkit-scrollbar-thumb{
    background: linear-gradient(180deg,#0e6b4f,#3da684);
    border-radius:8px;
  }
  .msg.scrollable::after{
    content:""; position:absolute; left:0; right:0; bottom:0; height:16px; pointer-events:none;
    background: linear-gradient(to bottom, rgba(247,244,233,0), rgba(247,244,233,.92));
  }
  .hint{
    position:absolute; bottom:4px; right:8px;
    font-size:11px; line-height:1; opacity:.9;
    color:#0b3d2e; background:rgba(14,107,79,.12);
    padding:4px 6px; border-radius:6px; user-select:none; display:none;
  }
  .msg.scrollable .hint{ display:block; }
  noscript{display:block;text-align:center;padding:8px 12px;font-size:16px;}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="message" class="msg">Loading…</div>
      <div id="hint" class="hint">Scroll ▾</div>
    </div>
  </div>
  <noscript>(no script) Add <code>?t=Your%20message</code> to the URL.</noscript>

<script>
(function(){
  function qs(){ return new URLSearchParams(location.search); }
  function num(x, fb){ var n = Number(x); return isFinite(n) ? n : fb; }
  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

  var p = qs();

  // Message and alignment
  var txt = (p.get("t") || "").replace(/\r\n/g,"\n").replace(/\r/g,"\n");
  if (!txt) txt = "(no message)";
  var align = p.get("align");
  if (align !== "left" && align !== "right") align = "center";

  var msg  = document.getElementById("message");
  var hint = document.getElementById("hint");
  msg.textContent = txt;
  msg.style.textAlign = align;

  // --- Sizing mode (default = vh) ---
  var mode = (p.get("mode") || "vh").toLowerCase();

  // VH controls (percent of viewer height)
  var prefVH = num(p.get("pref_vh"), 18);   // good starting point for shallow banners
  var minVH  = num(p.get("min_vh"),  10);
  var maxVH  = num(p.get("max_vh"),  28);

  // PX controls (only used if mode=px)
  var prefPX = num(p.get("pref_px"), 44);
  var minPX  = num(p.get("min_px"),  16);
  var maxPX  = num(p.get("max_px"),  84);

  // Common controls
  var prefLH = num(p.get("pref_lh"), 1.26);
  var minLH  = num(p.get("min_lh"),  1.16);
  var padVM  = num(p.get("pref_pad"),1.2);
  var minPad = num(p.get("min_pad"), 1.0);

  // Apply inline so SL MOAP honors it
  function apply(size, lh, padVmin){
    if (mode === "px")  msg.style.fontSize  = size + "px";
    else                msg.style.fontSize  = size + "vh";
    msg.style.lineHeight = String(lh);
    msg.style.padding    = padVmin + "vmin";
    msg.style.paddingBottom = "calc(" + padVmin + "vmin + 6px)";
  }

  // Fit helpers
  function fits(){
    return msg.scrollHeight <= msg.clientHeight + 0.5;
  }
  function bestSize(lo, hi, lh, pad){
    var best = lo, tries = 0;
    while (hi - lo > 0.1 && tries < 24){        // precision: 0.1 vh/px
      var mid = (lo + hi) / 2;
      apply(mid, lh, pad);
      if (fits()){ best = mid; lo = mid; } else { hi = mid; }
      tries++;
    }
    apply(best, lh, pad);
    return best;
  }

  // Seed values
  var curPad = clamp(padVM, minPad, Math.max(minPad, 1.6));
  var curLH  = clamp(prefLH, minLH, 1.36);
  var curSize = (mode === "px")
    ? clamp(prefPX, minPX, maxPX)
    : clamp(prefVH, minVH, maxVH);

  apply(curSize, curLH, curPad);

  try{
    // 1) Maximize font within bounds
    if (mode === "px") bestSize(minPX, maxPX, curLH, curPad);
    else               bestSize(minVH, maxVH, curLH, curPad);

    // 2) Tighten line-height if still too tall
    if (!fits()){
      var step = 0.02;
      while (curLH - step >= minLH){
        curLH = +(curLH - step).toFixed(2);
        apply(curSize, curLH, curPad);
        if (fits()) break;
      }
    }

    // 3) Shave padding if still too tall
    if (!fits()){
      var pstep = 0.2;
      while (curPad - pstep >= minPad){
        curPad = +(curPad - pstep).toFixed(2);
        apply(curSize, curLH, curPad);
        if (fits()) break;
      }
    }
  }catch(e){
    // Fail-safe defaults
    if (mode === "px") apply(32, 1.30, 1.0);
    else               apply(18, 1.30, 1.0);
  }

  // 4) Enable scroll if still overflowing
  if (!fits()){
    msg.classList.add("scrollable");
    hint.style.display = "block";
  }else{
    msg.classList.remove("scrollable");
    hint.style.display = "none";
  }

  // 5) Refit on resize (debounced)
  var t=null;
  window.addEventListener("resize", function(){
    clearTimeout(t);
    t = setTimeout(function(){
      // refit at same bounds
      if (mode === "px") bestSize(minPX, maxPX, curLH, curPad);
      else               bestSize(minVH, maxVH, curLH, curPad);
      if (!fits()){ msg.classList.add("scrollable"); hint.style.display="block"; }
      else         { msg.classList.remove("scrollable"); hint.style.display="none"; }
    }, 60);
  });
})();
</script>
</body>
</html>
